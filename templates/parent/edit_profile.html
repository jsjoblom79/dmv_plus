{% extends 'base.html' %}

{% block title %}Edit Profile - DMV+{% endblock %}

{% block content %}
<div class="container" style="max-width: 700px;">
    <div style="margin-bottom: 20px;">
        <a href="{% url 'parent_dashboard' %}" style="color: #4CAF50;">← Back to Dashboard</a>
    </div>

    <h1>Edit Your Profile</h1>
    <p>Update your personal and contact information</p>

    {% if messages %}
        <div class="messages">
            {% for message in messages %}
                <div class="message {{ message.tags }}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <form method="post" action="{% url 'edit_parent_profile' %}" enctype="multipart/form-data" id="profile-form">
        {% csrf_token %}

        <!-- Profile Photo Section -->
        <h3 style="margin-top: 20px; margin-bottom: 15px;">Profile Photo</h3>

        <div style="display: flex; gap: 30px; align-items: start; margin-bottom: 30px;">
            <!-- Current Photo Preview -->
            <div style="text-align: center;">
                <div style="width: 150px; height: 150px; border-radius: 50%; overflow: hidden; border: 3px solid #ddd; background-color: #f5f5f5;">
                    <img id="photo-preview" src="{{ parent_profile.get_photo_url }}" alt="Profile Photo" style="width: 100%; height: 100%; object-fit: cover;">
                </div>
                <p style="margin-top: 10px; font-size: 0.9em; color: #666;">Current Photo</p>
            </div>

            <!-- Photo Upload Controls -->
            <div style="flex: 1;">
                <div class="form-group">
                    <label for="photo">Upload New Photo:</label>
                    <input
                        type="file"
                        id="photo"
                        name="photo"
                        accept="image/*"
                        style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;"
                    >
                    <small>JPG, PNG, GIF, or WebP. Max 5MB. Will be resized to 400x400px.</small>
                </div>

                <!-- Rotation Controls -->
                <div class="form-group" id="rotation-controls" style="display: none;">
                    <label>Rotate Photo:</label>
                    <input type="hidden" id="rotation" name="rotation" value="0">
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button type="button" onclick="rotatePhoto(-90)" style="padding: 8px 16px; background-color: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; width: auto;">
                            ↺ Left 90°
                        </button>
                        <button type="button" onclick="rotatePhoto(90)" style="padding: 8px 16px; background-color: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; width: auto;">
                            ↻ Right 90°
                        </button>
                        <button type="button" onclick="resetRotation()" style="padding: 8px 16px; background-color: #666; color: white; border: none; border-radius: 4px; cursor: pointer; width: auto;">
                            Reset
                        </button>
                    </div>
                    <p style="margin-top: 5px; font-size: 0.9em; color: #666;">Current rotation: <span id="rotation-display">0°</span></p>
                </div>

                {% if parent_profile.photo %}
                <div class="form-group">
                    <label style="display: flex; align-items: center; font-weight: normal; cursor: pointer;">
                        <input
                            type="checkbox"
                            id="remove_photo"
                            name="remove_photo"
                            value="true"
                            style="width: auto; margin-right: 10px;"
                        >
                        <span style="font-weight: bold; color: #f44336;">Remove Current Photo</span>
                    </label>
                </div>
                {% endif %}
            </div>
        </div>

        <h3 style="margin-top: 30px; margin-bottom: 15px;">Personal Information</h3>

        <div class="form-row">
            <div class="form-group">
                <label for="first_name">First Name: *</label>
                <input
                    type="text"
                    id="first_name"
                    name="first_name"
                    required
                    value="{{ user.first_name }}"
                >
            </div>

            <div class="form-group">
                <label for="last_name">Last Name: *</label>
                <input
                    type="text"
                    id="last_name"
                    name="last_name"
                    required
                    value="{{ user.last_name }}"
                >
            </div>
        </div>

        <div class="form-group">
            <label for="email">Email Address: *</label>
            <input
                type="email"
                id="email"
                name="email"
                required
                value="{{ user.email }}"
            >
            <small>This is your login email</small>
        </div>

        <div class="form-group">
            <label for="phone">Phone Number:</label>
            <input
                type="text"
                id="phone"
                name="phone"
                placeholder="(555) 123-4567"
                value="{{ parent_profile.phone|default:'' }}"
            >
        </div>

        <h3 style="margin-top: 30px; margin-bottom: 15px;">Address</h3>

        <div class="form-group">
            <label for="address1">Address Line 1:</label>
            <input
                type="text"
                id="address1"
                name="address1"
                placeholder="123 Main Street"
                value="{{ parent_profile.address1|default:'' }}"
            >
        </div>

        <div class="form-group">
            <label for="address2">Address Line 2:</label>
            <input
                type="text"
                id="address2"
                name="address2"
                placeholder="Apt 4B"
                value="{{ parent_profile.address2|default:'' }}"
            >
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="city">City:</label>
                <input
                    type="text"
                    id="city"
                    name="city"
                    placeholder="Denver"
                    value="{{ parent_profile.city|default:'' }}"
                >
            </div>

            <div class="form-group">
                <label for="state">State:</label>
                <input
                    type="text"
                    id="state"
                    name="state"
                    placeholder="CO"
                    maxlength="2"
                    value="{{ parent_profile.state|default:'' }}"
                >
                <small>Two-letter code (e.g., CO)</small>
            </div>
        </div>

        <div class="form-group">
            <label for="zipcode">ZIP Code:</label>
            <input
                type="text"
                id="zipcode"
                name="zipcode"
                placeholder="80202"
                value="{{ parent_profile.zipcode|default:'' }}"
            >
        </div>

        <div class="form-actions" style="display: flex; gap: 10px; margin-top: 30px;">
            <button type="submit" class="btn-primary">Save Changes</button>
            <a href="{% url 'parent_dashboard' %}" style="display: inline-block; padding: 10px 20px; background-color: #666; color: white; text-decoration: none; border-radius: 4px; text-align: center; flex: 1;">
                Cancel
            </a>
        </div>
    </form>
</div>

<script>
let currentRotation = 0;
let uploadedImage = null;

document.getElementById('photo').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
            uploadedImage = event.target.result;
            currentRotation = 0;
            updatePreview();
            document.getElementById('rotation-controls').style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
});

function rotatePhoto(degrees) {
    currentRotation = (currentRotation + degrees) % 360;
    if (currentRotation < 0) currentRotation += 360;
    updatePreview();
}

function resetRotation() {
    currentRotation = 0;
    updatePreview();
}

function updatePreview() {
    const preview = document.getElementById('photo-preview');
    const rotationInput = document.getElementById('rotation');
    const rotationDisplay = document.getElementById('rotation-display');

    if (uploadedImage) {
        preview.src = uploadedImage;
        preview.style.transform = `rotate(${currentRotation}deg)`;
        rotationInput.value = currentRotation;
        rotationDisplay.textContent = currentRotation + '°';
    }
}

// Reset rotation controls when remove photo is checked
document.getElementById('remove_photo')?.addEventListener('change', function(e) {
    if (e.target.checked) {
        document.getElementById('photo').value = '';
        document.getElementById('rotation-controls').style.display = 'none';
        currentRotation = 0;
        uploadedImage = null;
    }
});
</script>
{% endblock %}